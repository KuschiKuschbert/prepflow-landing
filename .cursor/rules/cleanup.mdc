---
alwaysApply: true
---

## üßπ **Cleanup Standards & Automated Enforcement**

**Purpose:** Centralized documentation of ALL cleanup standards with automated enforcement capabilities.

**See Also:**
- `development.mdc` - Development workflow and refactoring standards
- `design.mdc` - Design system and UI standards
- `core.mdc` - Core TypeScript and naming standards
- `security.mdc` - Security patterns and validation
- `testing.mdc` - Testing and quality assurance standards
- `operations.mdc` - Performance and operations standards
- `implementation.mdc` - API and database patterns
- `technical.mdc` - Technical patterns and autosave

**Automated Enforcement:**
- Check: `npm run cleanup:check` - Validates all standards
- Fix: `npm run cleanup:fix` - Auto-fixes available issues
- Report: `npm run cleanup:report` - Generates detailed reports

---

## üìè **File Size Limits**

**Source:** `development.mdc` (File Refactoring Standards)

**MANDATORY Limits:**
- **Pages:** 500 lines maximum
- **Components:** 300 lines maximum
- **API Routes:** 200 lines maximum
- **Utilities:** 150 lines maximum
- **Hooks:** 120 lines maximum (increased from 100 to accommodate coordination hooks)
- **Data Files:** 2000 lines maximum (seed data, translations)

**Enforcement:**
- Check: `scripts/cleanup.js` (file-sizes check)
- Fix: Manual refactoring required (see `development.mdc` for guidelines)

**Related:**
- See `development.mdc` (File Refactoring Standards) for refactoring guidelines
- See `development.mdc` (Git Best Practices) for refactoring workflow

---

## üíª **Code Quality Standards**

### **TypeScript Standards**

**Source:** `development.mdc` (Code Quality Requirements), `core.mdc` (TypeScript Ref Types)

**Standards:**
- Strict typing, no `any` types without justification
- Ref Types: `RefObject<HTMLElement | null>` (MANDATORY)
- No `.catch()` chaining on Supabase query builders (MANDATORY)

**Enforcement:**
- Check: `scripts/cleanup.js` (typescript-ref-types check)
- Fix: Manual fixes required

**Related:**
- See `core.mdc` (TypeScript Ref Types) for detailed patterns
- See `core.mdc` (Supabase TypeScript Gotcha) for query patterns

### **Console.log Migration**

**Source:** `development.mdc` (Codemod Rules)

**Standard:**
- Use `logger.dev()` instead of `console.log()` (360 instances found)
- Use `logger.error()` instead of `console.error()`
- Use `logger.warn()` instead of `console.warn()`

**Enforcement:**
- Check: `scripts/cleanup.js` (console-logs check)
- Fix: `scripts/cleanup.js --fix` (uses existing codemod)

**Related:**
- See `development.mdc` (Console Migration Codemod) for migration details
- See `lib/logger.ts` for logger utility

### **Naming Conventions**

**Source:** `development.mdc` (Naming Conventions)

**Standards:**
- Files: kebab-case (e.g., `exit-intent-popup.tsx`)
- Components: PascalCase (e.g., `ExitIntentPopup`)
- Functions: camelCase with descriptive verbs
- Constants: UPPER_SNAKE_CASE (e.g., `GTM_EVENTS`)

**Enforcement:**
- Check: `scripts/cleanup.js` (naming check)
- Fix: Manual fixes required

**Related:**
- See `development.mdc` (Naming Conventions) for complete guidelines

---

## üé® **Design System Standards**

### **Breakpoint Standards**

**Source:** `design.mdc` (Custom Breakpoint System)

**MANDATORY Standards:**
- Custom breakpoints ONLY: `tablet:`, `desktop:`, `large-desktop:`, `xl:`, `2xl:`
- Rogue breakpoints to fix: `sm:`, `md:`, `lg:` (found in 5+ files, DISABLED)

**Enforcement:**
- Check: `scripts/cleanup.js` (breakpoints check) or `npm run detect-breakpoints`
- Fix: `scripts/cleanup.js --fix` (uses existing breakpoint codemod)

**Related:**
- See `design.mdc` (Custom Breakpoint System) for complete breakpoint map
- See `scripts/detect-breakpoints.js` for detection script
- See `scripts/codemods/breakpoint-migration.js` for migration codemod

### **Icon Standards**

**Source:** `design.mdc` (Icon Standards)

**MANDATORY Standards:**
- Use Lucide React icons exclusively (no emoji icons)
- Use `Icon` wrapper component from `components/ui/Icon.tsx`
- Sizes: `xs` (12px), `sm` (16px), `md` (20px), `lg` (24px), `xl` (32px)
- Accessibility: Auto `aria-hidden` or `aria-label`

**Enforcement:**
- Check: `scripts/cleanup.js` (icons check)
- Fix: Manual fixes required

**Related:**
- See `design.mdc` (Icon Standards) for complete guidelines
- See `components/ui/Icon.tsx` for Icon component implementation

### **Cyber Carrot Design System Standards**

**Source:** `design.mdc` (Cyber Carrot Design System)

**Standards:**
- Border radius: `rounded-3xl` (containers), `rounded-2xl` (cards)
- Colors: Use CSS variables (`--primary`, `--secondary`, etc.)
- Typography: Geist Sans (primary), Geist Mono (monospace)
- Touch targets: 44px minimum
- Z-index hierarchy: Documented in design.mdc

**Enforcement:**
- Check: Manual review (design patterns)
- Fix: Manual fixes required

**Related:**
- See `design.mdc` (Cyber Carrot Design System) for complete guidelines

---

## üìù **Documentation Standards**

### **JSDoc Requirements**

**Source:** `development.mdc` (JSDoc Documentation Standards)

**MANDATORY Standards:**
- All public functions, components, hooks must have JSDoc
- Required fields: Description, @param, @returns
- Optional fields: @throws, @example, @see

**Enforcement:**
- Check: `scripts/cleanup.js` (jsdoc check)
- Fix: Manual fixes required

**Related:**
- See `development.mdc` (JSDoc Documentation Standards) for templates
- See `development.mdc` (JSDoc Template) for examples

---

## üé® **Code Formatting Standards**

### **Prettier Configuration**

**Source:** `development.mdc` (Prettier Configuration)

**Standards:**
- Semicolons: Required
- Single quotes: Required
- Print width: 100 characters
- Trailing commas: All
- Tailwind plugin: Auto-sort classes

**Enforcement:**
- Check: `scripts/cleanup.js` (prettier check) or `npm run format:check`
- Fix: `scripts/cleanup.js --fix` (uses Prettier) or `npm run format`

**Related:**
- See `development.mdc` (Prettier Configuration) for complete settings
- See `.prettierrc` for configuration file

### **ESLint Standards**

**Source:** `development.mdc` (ESLint Configuration)

**Standards:**
- React hooks rules: Enforced
- Unescaped entities: Enforced (use `&apos;`, `&quot;`)
- React compiler rules: Disabled

**Enforcement:**
- Check: `scripts/cleanup.js` (eslint check) or `npm run lint`
- Fix: `scripts/cleanup.js --fix` (uses ESLint --fix)

**Related:**
- See `development.mdc` (ESLint Configuration) for complete rules
- See `eslint.config.mjs` for configuration file

---

## üîÑ **Git Workflow Standards**

**Source:** `development.mdc` (Git Best Practices)

**MANDATORY Standards:**
- Never work directly on main branch
- Create feature branch: `improvement/feature-name`
- Test before merge
- Use Conventional Commits format

**Enforcement:**
- Check: Manual review (git workflow)
- Fix: Manual fixes required

**Related:**
- See `development.mdc` (Git Best Practices) for complete workflow
- See `development.mdc` (Automatic CHANGELOG Generation) for commit format

---

## üîå **API Standards**

**Source:** `implementation.mdc` (API Response Standards)

**Status:** ‚úÖ Fully Implemented

**MANDATORY Standards:**
- Success responses must use `{ success: true, message, data }`
- Error responses must use `ApiErrorHandler.createError()`
- All error responses must include proper HTTP status codes
- All API routes must use `ApiErrorHandler` for error responses
- All API routes must use `logger.error()` for error logging (not console.error)
- All API routes must have try-catch blocks for async operations
- POST/PUT/PATCH routes must use Zod schemas for input validation

**Enforcement:**
- Check: `scripts/cleanup.js` (api-patterns check)
- Fix: Manual fixes required

**Related:**
- See `implementation.mdc` (API Response Standards) for complete guidelines
- See `ERROR_HANDLING_STANDARDS.md` for error handling patterns
- **Example:** `app/api/image-proxy/route.ts` - Demonstrates proper `ApiErrorHandler` usage with comprehensive error handling (validation errors, timeout errors, abort errors, fetch errors)

---

## üóÑÔ∏è **Database Standards**

**Source:** `implementation.mdc` (Database Schema Standards), `core.mdc` (Supabase TypeScript Gotcha)

**Status:** ‚úÖ Fully Implemented

**MANDATORY Standards:**
- Supabase parameterized queries ONLY (no string concatenation)
- No `.catch()` chaining on query builders (MANDATORY)
- Use `const { data, error } = await` pattern with explicit error handling
- Database errors must be handled with `ApiErrorHandler`
- Database errors must be logged with `logger.error()`
- Standard table structure with `created_at`, `updated_at`

**Enforcement:**
- Check: `scripts/cleanup.js` (database-patterns check)
- Fix: Manual fixes required

**Related:**
- See `core.mdc` (Supabase TypeScript Gotcha) for query patterns
- See `implementation.mdc` (Database Schema Standards) for table structure

---

## üîí **Security Standards**

**Source:** `security.mdc` (Security Standards)

**Status:** ‚úÖ Fully Implemented

**MANDATORY Standards:**
- Input validation: Zod schemas for all POST/PUT/PATCH routes
- Validation must occur before database operations
- Rate limiting: 100 req/15min (default), 10 req/min (auth) - warning if missing
- SQL injection: Parameterized queries only (no string concatenation)
- XSS: Sanitize user content (dangerouslySetInnerHTML must be sanitized)
- Security headers: Configured in next.config.ts (X-Frame-Options, CSP, etc.)

**Enforcement:**
- Check: `scripts/cleanup.js` (security check)
- Fix: Manual fixes required

**Related:**
- See `security.mdc` (Security Standards) for complete guidelines
- See `security.mdc` (API Security) for API security patterns
- **Example:** `app/api/image-proxy/route.ts` - Demonstrates security best practices: domain whitelisting, URL validation, protocol validation (HTTP/HTTPS only), input sanitization

---

## ‚ö° **Performance Standards**

**Source:** `operations.mdc` (Performance Standards)

**Status:** ‚úÖ Fully Implemented

**Standards:**
- LCP: < 2.5 seconds
- FID: < 100 milliseconds
- CLS: < 0.1
- API response: < 500ms (p95)
- Bundle size budgets:
  - Total bundle: 500KB (500000 bytes)
  - JavaScript bundle: 200KB (200000 bytes)
  - CSS bundle: 50KB (50000 bytes)

**Enforcement:**
- Check: `scripts/cleanup.js` (performance check)
- Fix: Manual optimization required (violations provide actionable recommendations)

**Implementation Details:**
- Analyzes bundle sizes from `.next/static` directory (requires `npm run build` first)
- Compares against budgets from `scripts/check-performance-budget.js`
- Uses logic from `scripts/analyze-bundle.js` for bundle analysis
- Only runs if `.next` directory exists (gracefully skips if not built)
- Creates violations for exceeded budgets with specific recommendations

**Related:**
- See `operations.mdc` (Performance Standards) for complete targets
- See `operations.mdc` (Performance Monitoring) for monitoring guidelines
- See `scripts/analyze-bundle.js` for bundle analysis implementation
- See `scripts/check-performance-budget.js` for budget definitions

---

## üß™ **Testing Standards**

**Source:** `testing.mdc` (Testing Standards)

**Standards:**
- Coverage: 60% minimum, 80% target
- Critical paths: 100% coverage
- Accessibility: WCAG 2.1 AA compliance
- Color contrast: 4.5:1 minimum

**Enforcement:**
- Check: Manual review (test coverage)
- Fix: Manual fixes required

**Related:**
- See `testing.mdc` (Testing Standards) for complete guidelines
- See `testing.mdc` (Test Coverage Targets) for coverage requirements

---

## üíæ **Autosave Standards**

**Source:** `technical.mdc` (Autosave & Drafts)

**Standards:**
- Use `deriveAutosaveId()` for stable IDs
- Avoid `"new"` as entityId
- Clear drafts after successful save

**Enforcement:**
- Check: Manual review (autosave patterns)
- Fix: Manual fixes required

**Related:**
- See `technical.mdc` (Autosave & Drafts) for complete guidelines
- See `lib/autosave-id.ts` for ID derivation utility

---

## ‚ö° **Optimistic Updates Standards**

**Source:** `development.mdc` (Optimistic Updates Pattern), `operations.mdc` (Optimistic Updates Standard)

**Status:** ‚úÖ Fully Implemented

**MANDATORY Standards:**
- All CRUD operations (Create, Update, Delete) must use optimistic updates
- Store original state before updates
- Update UI immediately (setState before await)
- Implement rollback logic (setState(originalState) in catch blocks)
- Use `useNotification` for user feedback
- No loading states for mutations (no isLoading or skeleton screens)
- No `fetchData()` calls after successful mutations

**Enforcement:**
- Check: `scripts/cleanup.js` (optimistic-updates check)
- Fix: Manual fixes required (requires refactoring)

**Related:**
- See `development.mdc` (Optimistic Updates Pattern) for detailed pattern and examples
- See `operations.mdc` (Optimistic Updates Standard) for performance targets
- See `implementation.mdc` (Optimistic Updates Implementation Pattern) for code examples
- See `lib/optimistic-updates.ts` for reusable utilities
- See `hooks/useOptimisticMutation.ts` for reusable hook

---

## ‚öõÔ∏è **React Patterns Standards**

**Source:** `development.mdc` (Code Quality Requirements)

**Status:** ‚úÖ Fully Implemented

**Standards:**
- Components using hooks or browser APIs must have `"use client"` directive
- Hooks must be called at top level (not conditionally)
- useEffect hooks with timers/event listeners must have cleanup functions
- useEffect hooks should have dependency arrays
- State should be updated using setState (no direct mutations)
- Consider useMemo/useCallback for expensive computations

**Enforcement:**
- Check: `scripts/cleanup.js` (react-patterns check)
- Fix: Manual fixes required
- Severity: `warning` (important but not blocking)

**Related:**
- See `development.mdc` (Code Quality Requirements) for complete guidelines
- See React documentation for hooks rules

---

## üö® **Error Handling Standards**

**Source:** `ERROR_HANDLING_STANDARDS.md`, `implementation.mdc` (Error Handling Standards)

**Status:** ‚úÖ Fully Implemented

**MANDATORY Standards:**
- All API routes must use `ApiErrorHandler.createError()` for error responses
- All error logging must use `logger.error()` (not console.error)
- All async operations must have try-catch blocks
- Errors in catch blocks must be logged or re-thrown (not silently ignored)
- Critical components with async operations should be wrapped in ErrorBoundary
- ApiErrorHandler.createError() must include error code as second parameter

**Enforcement:**
- Check: `scripts/cleanup.js` (error-handling check)
- Fix: Manual fixes required

**Related:**
- See `ERROR_HANDLING_STANDARDS.md` for complete error handling guidelines
- See `implementation.mdc` (Error Handling Standards) for API error handling
- See `lib/api-error-handler.ts` for ApiErrorHandler utility

---

## üí¨ **Voice Consistency Standards**

**Source:** `.cursor/rules/dialogs.mdc` (PrepFlow Voice Guidelines), `development.mdc` (PrepFlow Voice Guidelines)

**Status:** ‚úÖ Fully Implemented

**Standards:**
- Use contractions ("can't", "won't", "you'll") for natural speech
- Use kitchen/chef metaphors naturally ("start fresh", "all the trimmings")
- Be clear about consequences ("All temperature logs go with it")
- Keep messages concise but informative
- Avoid technical jargon
- Professional but friendly tone

**Enforcement:**
- Check: `scripts/cleanup.js` (voice-consistency check)
- Fix: `npm run cleanup:fix` (auto-fixes some violations via voice-consistency fix module)

**Related:**
- See `.cursor/rules/dialogs.mdc` (PrepFlow Voice Guidelines) for complete voice guidelines
- See `development.mdc` (PrepFlow Voice Guidelines) for voice standards
- See `docs/VOICE_ENHANCEMENT_GUIDE.md` for comprehensive voice enhancement guide

---

## üîç **Dead Code Detection**

**Source:** `development.mdc` (Dead Code Removal)

**Status:** ‚úÖ Fully Implemented

**Standards:**
- Remove unused components
- Remove unused functions
- Remove unused exports
- Remove unused imports (handled separately via unused-imports check)
- Remove commented-out code

**Enforcement:**
- Check: `scripts/cleanup.js` (dead-code check, unused-imports check)
- Fix: `npm run cleanup:fix` (auto-removes unused exports via ts-prune)

**Implementation Details:**
- Uses `ts-prune` to detect unused TypeScript/JavaScript exports
- Requires TypeScript project (`tsconfig.json`)
- Automatically excludes:
  - Test files (`*.test.ts`, `*.spec.ts`)
  - Type definition files (`*.d.ts`)
  - Build directories (`node_modules`, `.next`, `out`, `build`, `dist`)
- Parses ts-prune output format: `filePath:line:exportName`
- Auto-fix removes unused exports (handles named exports, re-exports)
- Gracefully handles missing prerequisites (skips if tsconfig.json not found)

**Usage:**
```bash
# Check for unused exports
npm run cleanup:check

# Auto-remove unused exports
npm run cleanup:fix
```

**Related:**
- See `development.mdc` (Dead Code Removal) for removal guidelines
- See `ts-prune` documentation for detection algorithm
- Note: Unused imports are handled separately by the unused-imports check

---

## üìä **Cleanup Script Usage**

### **Commands**

```bash
# Check all standards
npm run cleanup:check

# Auto-fix available issues
npm run cleanup:fix

# Generate detailed report
npm run cleanup:report

# Check and fix staged files only
npm run cleanup:staged

# Run all checks, fixes, and reports
npm run cleanup:all
```

### **Integration**

**Pre-commit Hook:**
- Automatically runs `cleanup:staged` on commit
- Blocks commit on critical violations
- Auto-fixes safe issues

**CI Pipeline:**
- Runs `cleanup:check` on all PRs
- Generates report artifact
- Fails build on critical violations

**See Also:**
- `scripts/cleanup.js` - Main cleanup script
- `scripts/cleanup/checks/` - Individual check modules
- `scripts/cleanup/fixes/` - Individual fix modules
