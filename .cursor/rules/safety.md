# Safety — Before Destructive Changes, Sacred Files & Rollback Steps

## Before Any Destructive Change

Always answer these questions before modifying, deleting, or restructuring:

1. **Is this file in a protected area?** (see Sacred Files below)
2. **Is this a migration file?** (never edit existing migrations)
3. **Will this break a running user's session?** (auth changes, schema changes)
4. **Is there a test covering this?** (if yes, update the test first)
5. **Can this be reversed?** (if not, document it in `TECH_DEBT.md` instead of proceeding)

If unsure about any answer: **document in `TECH_DEBT.md` and skip**. Never guess.

## Sacred Files — Never Modify Without Explicit Instruction

| File / Directory          | Why Protected                              | Override                                            |
| ------------------------- | ------------------------------------------ | --------------------------------------------------- |
| `app/curbos/`             | CurbOS integration — external dependency   | `ALLOW_CURBOS_MODIFY=1` + explicit user instruction |
| `app/nachotaco/`          | Excluded from all tooling; external area   | Never modify                                        |
| `migrations/*.sql`        | Database migrations are immutable once run | Add new file only                                   |
| `package-lock.json`       | Only npm manages this                      | `npm install` only                                  |
| `.next/`                  | Build output — regenerated on build        | Never edit                                          |
| `coverage/`               | Test output                                | Never edit                                          |
| `e2e/simulation/reports/` | Simulation reports — regenerated by tests  | Never edit manually                                 |
| `.husky/pre-commit`       | Git hook — changes affect all developers   | Only with explicit approval                         |
| `.github/workflows/`      | CI/CD configuration                        | Only with explicit approval                         |

## Before Modifying Database Schema

1. Check `migrations/` for existing migration with same change
2. Create a new migration file: `YYYYMMDD_HHMMSS_description.sql`
3. Test on local Supabase first (`supabase db reset && supabase db push`)
4. **Never** modify existing migration files — they may already be applied in production
5. Always include a rollback migration

## Before Modifying Auth Flows

1. Test with a real Auth0 account (not just mock)
2. Verify callback URLs in Auth0 dashboard match `AUTH0_BASE_URL`
3. Test logout works (Allowed Logout URLs must be configured exactly)
4. Check `proxy.ts` allowlist enforcement still works after changes

## Before Modifying API Route Handlers

1. Check if there are active callers (webapp pages, other API routes, E2E tests)
2. Maintain backward-compatible response shapes when possible
3. If breaking change: update all callers in same commit
4. Add/update corresponding E2E test

## Before Modifying `lib/supabase.ts`

This is the singleton database client used everywhere. Changes here affect all database operations.

1. Run full test suite before and after
2. Verify both `supabase` (anon) and `supabaseAdmin` (service role) still work

## Before Running Database Reset Scripts

- `POST /api/db/reset` — wipes ALL domain tables. **Irreversible in production**.
- `POST /api/db/reset-self` — wipes current user's data only
- Both require `X-Admin-Key: $SEED_ADMIN_KEY` header
- Both are blocked in production (`NODE_ENV === 'production'`)

```bash
# Safe to run only in development
curl -X POST http://localhost:3000/api/db/reset \
  -H "X-Admin-Key: your_seed_admin_key"
```

## Rollback Steps

### If a deployment breaks production

1. Go to Vercel dashboard → Deployments
2. Find the last working deployment
3. Click "Promote to Production"
4. Investigate the broken commit, fix, and redeploy

### If a migration breaks the database

1. Run the rollback migration (always write one when creating a migration)
2. If no rollback exists: restore from Supabase automated backup
3. Supabase retains 30 days of backups (Vercel dashboard → Supabase → Backups)

### If an audit branch breaks the build

```bash
# Discard the audit branch entirely
git checkout main
git branch -D improvement/skill-audit

# Or revert specific commits
git revert <commit-hash>
```

### If a refactored file breaks functionality

```bash
# Revert single file to last committed state
git checkout HEAD -- path/to/file.ts

# Revert last commit (keeps changes staged)
git reset --soft HEAD~1
```

## Pre-Deploy Safety Checklist

```bash
# Run ALL of these before pushing to main
npm run lint           # Must pass
npm run type-check     # Must pass
npm run format:check   # Must pass
npm run build          # Must succeed
npm test               # Must pass (or known failures documented)
```

Or run all at once: `npm run pre-deploy`

## When to Stop and Ask

Stop and ask the user (don't guess) when:

- A change would affect more than 3 unrelated domains simultaneously
- A schema change has no obvious rollback path
- Deleting a file that has references in more than 5 other files
- Modifying authentication or payment processing logic
- The task description is ambiguous and the wrong interpretation could break production
