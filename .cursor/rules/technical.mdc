---
alwaysApply: true
---
## ðŸš¨ **Critical Issues to Address**

### **Immediate Fixes Required**

1. **Image Optimization:** Large images without proper sizing
2. **Performance:** Core Web Vitals optimization needed

### **Conversion Blockers**

1. **Form Validation:** Error handling and success states needed
2. **Trust Indicators:** Security badges and company info
3. **Urgency Elements:** Countdown or scarcity triggers

## Data & Schema Standards

- Canonical ingredient field name: `ingredient_name`.
- Historical references to `ingredients.name` may exist; when reading, alias or normalize to `ingredient_name`.
- Prefer the server endpoint `GET /api/recipes/[id]/ingredients` for normalized joins.

## Next.js 16 Route Handlers

- In App Router, `context.params` is a Promise. Handlers must await it:
  - `export async function GET(req, context: { params: Promise<{ id: string }> }) { const { id } = await context.params; }`
- Prefer proxy over middleware per deprecation notice. Middleware is still present for prod allowlist, but should be migrated to proxy when feasible.

## Autosave & Drafts (Global)

- Standardize IDs: Use `deriveAutosaveId(entityType, serverId?, keyFields)` for new entities to avoid `"new"` key churn.
- Flush Behavior: Autosave flushes on data change debounce, visibility change, pagehide, and beforeunload.
- Global Indicator: Header shows Saving/Saved/Error via a global event (`autosave:status`).
- Draft Recovery: Suppresses prompts for drafts younger than 10 minutes, empty drafts, and drafts without minimal signal (e.g., missing `ingredient_name` or `name`).
- Purge Policy: Client migration purges drafts older than 7 days and re-keys `"new"`/`tmp_*` entries to stable IDs on startup.
- Server Parity: Demo saves clear drafts; production keeps drafts on 4xx/5xx and surfaces an error.
- UI Contracts:
- Forms using autosave must pass a stable `entityId` (prefer server ID; otherwise `deriveAutosaveId`).
- After successful save, drafts must be cleared (handled centrally in `useAutosave`).

## Optimistic Updates (Global)

- **MANDATORY:** All CRUD operations must use optimistic updates to eliminate loading delays.
- **Pattern:** Store original state â†’ Update UI immediately â†’ Make API call â†’ Revert on error
- **Utilities:** Use `lib/optimistic-updates.ts` for generic CRUD operations or `hooks/useOptimisticMutation.ts` for custom mutations.
- **State Management:** Optimistic updates work with React state (`useState`) - store original state before updates, revert on error.
- **User Feedback:** Use `useNotification` hook for success/error notifications, never show loading states for mutations.
- **Error Handling:** Always implement rollback logic - restore original state if API call fails.
- **Background Refresh:** Optionally refresh statistics or related data in background (non-blocking) after successful mutations.
- **No Post-Success Fetches:** Never call `fetchData()` after successful mutations - rely on optimistic updates.

**See Also:**
- `development.mdc` (Optimistic Updates Pattern) - Detailed pattern and examples
- `operations.mdc` (Optimistic Updates Standard) - Performance targets
- `implementation.mdc` (Optimistic Updates Implementation Pattern) - Code examples

## ðŸ¤– **Automated Enforcement**

**Cleanup System:** See `cleanup.mdc` for comprehensive automated enforcement of all technical standards.

**Available Checks:**
- Autosave patterns: Manual review (autosave ID usage)
- Next.js patterns: Manual review (route handler patterns)

**Available Fixes:**
- Autosave patterns: Manual fixes required
- Next.js patterns: Manual fixes required

**Standards Reference:** See `cleanup.mdc` (Autosave Standards) for complete enforcement details.

### Implemented

- `hooks/useAutosave.ts`: status broadcasting + flush on lifecycle.
- `lib/autosave-id.ts`: stable ID derivation.
- `app/providers.tsx`: one-time migration (purge/re-key) on startup.
- `app/webapp/components/DraftRecovery.tsx`: prompt suppression and purge of >24h drafts.
- `app/webapp/components/ModernNavigation.tsx` + `AutosaveGlobalIndicator`: global status.
- Key forms updated to stable IDs: `RecipeForm`, `IngredientForm`.

### Action Items for New Forms

- Import and use `deriveAutosaveId` with meaningful key fields.
- Avoid passing `"new"` as `entityId` to `useAutosave`.
- Ensure minimal field validation so autosave is only enabled when meaningful.

<!-- redeploy: noop update at 2025-11-03 23:55Z -->
