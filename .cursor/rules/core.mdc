---
alwaysApply: true
---
## Auth, Allowlist, and Billing Setup

**üìö Complete Reference:** See `docs/AUTH0_STRIPE_REFERENCE.md` for comprehensive Auth0 and Stripe configuration, setup, testing, and troubleshooting guide.

### Auth (Auth0 SDK)

**MANDATORY Environment Variables:**
- `AUTH0_SECRET` - Generate with: `openssl rand -hex 32` (minimum 32 characters)
- `AUTH0_BASE_URL` - Application URL (`http://localhost:3000` for dev, `https://www.prepflow.org` for prod)
- `AUTH0_ISSUER_BASE_URL` - Auth0 tenant URL (e.g., `https://dev-xxx.us.auth0.com`)
- `AUTH0_CLIENT_ID` - Auth0 application client ID
- `AUTH0_CLIENT_SECRET` - Auth0 application client secret
- `AUTH0_DOMAIN` - Auth0 domain (optional, extracted from AUTH0_ISSUER_BASE_URL if not set)

**Deprecated (Backward Compatibility):**
- `NEXTAUTH_URL` - Use `AUTH0_BASE_URL` instead (kept as fallback during migration)
- `NEXTAUTH_SECRET` - Use `AUTH0_SECRET` instead (no longer used)

**MANDATORY Auth0 Dashboard Configuration:**
- **Allowed Callback URLs:** Must include `/api/auth/callback` for all environments (Auth0 SDK uses `/api/auth/callback`, not `/api/auth/callback/auth0`)
- **Allowed Logout URLs:** Must include exact logout URLs (with and without trailing slash) - **CRITICAL** or logout will fail
- **Allowed Web Origins:** Must include application origins for CORS

**Implementation Files:**
- `lib/auth0.ts` - Auth0 SDK client instance and configuration
- `lib/auth-user-sync.ts` - User sync on first login (creates user record, updates last_login)
- `lib/auth0-management.ts` - Management API client for role extraction
- `lib/auth0-api-helpers.ts` - API route helpers for authentication
- `lib/auth0-middleware.ts` - Middleware helpers for authentication
- `proxy.ts` - Auth0 SDK proxy integration and allowlist enforcement (Next.js 16 proxy convention)

**MANDATORY Best Practices:**
- ‚úÖ User creation on first login (implemented in `lib/auth-user-sync.ts`)
- ‚úÖ Session management via Auth0 SDK (4-hour inactivity timeout, 24-hour absolute timeout)
- ‚úÖ Minimal scopes: `openid profile email` only
- ‚úÖ Role extraction with fallbacks (token ‚Üí Management API)
- ‚úÖ Email verification sync from Auth0
- ‚úÖ Never downgrade email verification status

**Routes:**
- `/api/auth/login` - Auth0 SDK login handler
- `/api/auth/callback` - Auth0 SDK callback handler
- `/api/auth/logout` - Auth0 SDK logout handler
- `/api/me` - Current user information
- Proxy enforces allowlist on `/webapp/**` and `/api/**` (except auth routes)

**See Also:**
- `docs/AUTH0_STRIPE_REFERENCE.md` (Auth0 Configuration section) - Complete setup guide
- `docs/AUTH0_LOCALHOST_SETUP.md` - Localhost-specific configuration
- `docs/AUTH0_LOGOUT_SETUP.md` - Logout configuration troubleshooting

### Allowlist Configuration

**MANDATORY:** Choose one allowlist configuration option:

- **Option 1: Development Mode** (Default)
  - In development (`NODE_ENV=development`), allowlist is automatically bypassed
  - All authenticated users are allowed
  - No configuration needed

- **Option 2: Disable Allowlist**
  - Set `DISABLE_ALLOWLIST=true` in environment variables
  - All authenticated users can access (useful for testing/friend access)
  - Works in both development and production

- **Option 3: Email Allowlist** (Production Recommended)
  - `ALLOWED_EMAILS` (comma-separated). Only allowlisted emails can access protected routes.
  - Format: `email1@example.com,email2@example.com,email3@example.com`
  - Unauthorized pages redirect to `/not-authorized`; APIs return 401/403.
  - Most secure option for production

### Shared Workspace

- **Current Configuration**: Shared workspace - all authenticated users access the same data
- **No User Isolation**: All users see and modify the same ingredients, recipes, menu dishes, etc.
- **User Display**: Current user's name/email is displayed in navigation header (desktop only)
- **Use Case**: Testing and friend access - not suitable for production with multiple customers
- **Documentation**: See `docs/FRIEND_ACCESS.md` for detailed configuration and usage instructions

### Billing (Stripe Integration)

**MANDATORY Environment Variables:**
- `STRIPE_SECRET_KEY` - Stripe secret key (`sk_test_...` for dev, `sk_live_...` for prod)
- `STRIPE_WEBHOOK_SECRET` - Webhook signing secret (`whsec_...`)
- `STRIPE_WEBHOOK_SECRET_DEV` - Optional: Dev-specific webhook secret (recommended)
- `STRIPE_WEBHOOK_SECRET_PROD` - Optional: Prod-specific webhook secret (recommended)
- `STRIPE_PRICE_STARTER_MONTHLY` - Price ID for Starter tier (`price_...`)
- `STRIPE_PRICE_PRO_MONTHLY` - Price ID for Pro tier (`price_...`)
- `STRIPE_PRICE_BUSINESS_MONTHLY` - Price ID for Business tier (`price_...`)

**MANDATORY Stripe Dashboard Configuration:**
- **Products:** Create Starter, Pro, Business products with monthly recurring prices
- **Webhook Endpoint:** `https://yourdomain.com/api/webhook/stripe`
- **Webhook Events:** `checkout.session.completed`, `customer.subscription.created`, `customer.subscription.updated`, `customer.subscription.deleted`, `invoice.payment_succeeded`, `invoice.payment_failed`
- **Webhook Secret:** Copy signing secret from Stripe Dashboard

**Implementation Files:**
- `lib/stripe.ts` - Stripe client singleton (API version: `2025-11-17.clover`)
- `app/api/billing/create-checkout-session/route.ts` - Checkout session creation
- `app/api/billing/create-portal-session/route.ts` - Customer portal creation
- `app/api/webhook/stripe/route.ts` - Webhook handler with signature verification
- `lib/tier-config.ts` - Subscription tier configuration
- `lib/entitlements.ts` - Entitlement checking
- `lib/feature-gate.ts` - Feature gating

**MANDATORY Best Practices:**
- ‚úÖ Webhook signature verification (all webhook requests)
- ‚úÖ Webhook idempotency (via `webhook_events` table)
- ‚úÖ Environment-specific webhook secrets (DEV/PROD)
- ‚úÖ Customer ID caching (via `billing_customers` table)
- ‚úÖ Metadata usage (tier, user_email in checkout sessions)
- ‚úÖ Expand parameters (reduce API calls)
- ‚úÖ Deleted customer handling (check `customer.deleted` flag)
- ‚úÖ Proper error handling (correct HTTP status codes for retries)

**Endpoints:**
- `POST /api/billing/create-checkout-session` - Create Stripe checkout session (requires auth)
- `POST /api/billing/create-portal-session` - Create Stripe customer portal (requires auth)
- `POST /api/webhook/stripe` - Stripe webhook handler (requires signature verification)

**Database Tables Required:**
- `users` - Subscription fields (tier, status, stripe_customer_id, stripe_subscription_id)
- `billing_customers` - Customer ID caching (user_email, stripe_customer_id)
- `webhook_events` - Idempotency tracking (event_id, processed)
- `user_notifications` - Notification system (user_email, notification_type)

**See Also:**
- `docs/AUTH0_STRIPE_REFERENCE.md` (Stripe Configuration section) - Complete setup guide
- `docs/STRIPE_SETUP_CHECKLIST.md` - Step-by-step Stripe setup
- `docs/STRIPE_INTEGRATION.md` - Detailed Stripe integration guide
- `security.mdc` - Security practices for secrets management and API security

## Landing v2 (Sign‚Äëin + Tour)

### IA

- Hero: concise value prop; CTAs: Sign in, Register, Tour
- Tour: 3‚Äì5 steps (Ingredients ‚Üí Recipes ‚Üí COGS ‚Üí Performance ‚Üí Temperature)
- Capabilities: 4 cards linking to tour anchors
- How it works: Add ‚Üí Analyze ‚Üí Act
- Security: Auth0, Supabase, privacy

### Components

- `app/components/landing/Hero.tsx` - Hero section
- `app/components/landing/TourModal.tsx` - Tour modal component
- `app/components/landing/sections/HowItWorksSection.tsx` - Process explanation (Add ‚Üí Analyze ‚Üí Act)

### QA Checklist

- Auth: NextAuth + Auth0 working; allowlist enforced on `/webapp/**` routes
- Tour modal: focus trap, Escape closes, arrows navigate
- Performance: Lighthouse ‚â• 90; CLS < 0.1; LCP < 2.5s
- Analytics: tour_open/close, step navigation, CTA clicks

## Development Utilities

- Reset and Seed (dev-only):
  - `POST /api/db/reset` ‚Äî wipes domain tables in FK-safe order.
  - `POST /api/populate-clean-test-data` ‚Äî single source of truth to generate all clean test data for the app (ingredients, recipes, suppliers, equipment, cleaning, compliance). Replaces existing data.
  - `POST /api/db/reset-self` ‚Äî authenticated self-reset that deletes only the current user's data (`user_id` scoped). Supports `?dry=1`. No reseed.
  - Both require header `X-Admin-Key: $SEED_ADMIN_KEY` and are blocked in production.
  - Optional `?dry=1` for a dry-run plan.

## ‚ö° Optimistic Updates (MANDATORY)

**Quick Reference:**
- **MANDATORY:** All CRUD operations (Create, Update, Delete) must use optimistic updates to eliminate loading delays
- **Pattern:** Store original state ‚Üí Update UI immediately ‚Üí Make API call ‚Üí Revert on error
- **Utilities:**
  - `lib/optimistic-updates.ts` - Generic CRUD operations (`createOptimisticDelete`, `createOptimisticUpdate`, `createOptimisticCreate`, `createOptimisticReorder`)
  - `hooks/useOptimisticMutation.ts` - Reusable hook for custom mutations with automatic rollback
- **Performance Target:** < 50ms perceived response time (no loading states for mutations)
- **State Management:** Works with React state (`useState`) - store original state before updates, revert on error
- **User Feedback:** Use `useNotification` hook for success/error notifications, never show loading states for mutations
- **Error Handling:** Always implement rollback logic - restore original state if API call fails
- **Background Refresh:** Optionally refresh statistics or related data in background (non-blocking) after successful mutations
- **Never:** Call `fetchData()` after successful mutations - rely on optimistic updates

**Standard Pattern:**
```typescript
// 1. Store original state for rollback
const originalState = [...currentState];

// 2. Optimistically update UI immediately
setState(optimisticUpdate);

// 3. Make API call in background
try {
  const response = await fetch('/api/endpoint', { method: 'DELETE' });
  const result = await response.json();

  if (response.ok) {
    // Success - show notification, refresh stats in background if needed
    showSuccess('Item deleted');
    refreshStatistics().catch(err => logger.error(err));
  } else {
    // Error - revert optimistic update
    setState(originalState);
    showError(result.error || 'Operation failed');
  }
} catch (err) {
  // Error - revert optimistic update
  setState(originalState);
  showError('Operation failed');
}
```

**See Also:**
- `development.mdc` (Optimistic Updates Pattern) - Detailed pattern and examples
- `implementation.mdc` (Optimistic Updates Implementation Pattern) - Code examples
- `operations.mdc` (Optimistic Updates Standard) - Performance targets
- `technical.mdc` (Optimistic Updates Global) - Quick reference

### Supabase TypeScript Gotcha (Vercel Build)

- Do not chain `.catch()` on Supabase query builders; they are not Promises until awaited.
- Always use:
  - `const { data, error } = await supabase.from('table').insert(row);`
- Handle `error` explicitly; avoid `.catch()` which breaks type checks on Vercel.

### TypeScript Ref Types (React useRef)

- **MANDATORY**: Always use `RefObject<HTMLElement | null>` when declaring ref types in interfaces or function return types.
- When using `useRef<HTMLElement>(null)`, TypeScript infers the type as `RefObject<HTMLElement | null>`, not `RefObject<HTMLElement>`.
- **Correct pattern:**

  ```typescript
  interface MyHookReturn {
    elementRef: React.RefObject<HTMLDivElement | null>; // ‚úÖ Correct
  }

  const elementRef = useRef<HTMLDivElement>(null); // Returns RefObject<HTMLDivElement | null>
  ```

- **Incorrect pattern:**
  ```typescript
  interface MyHookReturn {
    elementRef: React.RefObject<HTMLDivElement>; // ‚ùå Causes build errors
  }
  ```
- This prevents TypeScript build errors on Vercel: `Type 'RefObject<HTMLDivElement | null>' is not assignable to type 'RefObject<HTMLDivElement>'`.
- Always check ref types in hook return interfaces and component prop types.

## ü§ñ **Automated Enforcement**

**Cleanup System:** See `cleanup.mdc` for comprehensive automated enforcement of all core standards.

**Available Checks:**
- TypeScript ref types: `npm run cleanup:check` (validates RefObject patterns)
- Naming conventions: `npm run cleanup:check` (validates file/component/function naming)
- Supabase patterns: Manual review (query patterns)

**Available Fixes:**
- Naming conventions: Manual fixes required

**Standards Reference:** See `cleanup.mdc` (Code Quality Standards, Naming Conventions) for complete enforcement details.

## üéØ **Project Overview**

PrepFlow is a unified restaurant profitability optimization platform that helps caf√©s, restaurants, and food trucks analyze their menu costs, calculate COGS, and optimize gross profit margins. The platform combines a marketing landing page with a comprehensive webapp featuring subscription-based access.

**Target Market:** Independent restaurants, caf√©s, food trucks in Australia and globally
**Primary Goal:** Convert visitors into customers through lead generation and subscription sales
**Business Model:** Subscription-based SaaS ($29/month AUD) with 7-day free trial
**Platform:** Unified Next.js webapp with future React Native mobile apps

**Remember:** PrepFlow is a high-converting landing page that needs to balance technical excellence with conversion optimization. Every change should be measured and optimized for maximum impact on both user experience and business results.

## üèóÔ∏è **Technical Architecture**

### **Framework & Stack**

- **Frontend:** Next.js 16.0.0 with React 19 (App Router)
- **Styling:** Tailwind CSS 4 with custom CSS variables
- **Analytics:** Google Analytics 4, Google Tag Manager, Vercel Analytics
- **Deployment:** Vercel platform
- **Payment:** Stripe integration
- **Database:** Supabase PostgreSQL
- **Authentication:** NextAuth + Auth0 (user authentication), Supabase (database only)
- **Email:** Resend integration
- **Mobile:** React Native + Expo (future)

### **Key Components**

- **Analytics Stack:** ScrollTracker, GoogleAnalytics, GoogleTagManager
- **GTM Integration:** GoogleTagManager with data layer management
- **SEO Components:** Structured data, meta tags, OpenGraph
- **UI Components:** Custom Button, Card, and form components
- **UX Components:** LoadingSkeleton, ModernNavigation, ScrollToTop, ScrollProgress

### **File Structure**

**Note:** For detailed project structure with all directories and files, see the **"Current Project Structure"** section in `implementation.mdc`.

## üèóÔ∏è **Unified Architecture**

### **Platform Strategy**

- **Web-First Development:** Build for web with mobile-ready components
- **Universal Components:** Create components that work on web and mobile
- **Shared Business Logic:** Core functionality shared across platforms
- **Progressive Enhancement:** Start with web, add mobile capabilities

### **Authentication Flow**

- **NextAuth + Auth0:** User authentication via NextAuth with Auth0 provider
- **Supabase:** Database only (PostgreSQL) - not used for user authentication
- **Session Management:** Secure token storage and refresh via NextAuth
- **Allowlist Enforcement:** Proxy enforces email allowlist on `/webapp/**` and `/api/**` routes
- **Role-Based Access:** User and admin permissions managed via Auth0

### **Subscription Management**

- **Stripe Integration:** Payment processing and subscription management
- **Paywall System:** Protect premium features behind subscription
- **Trial Period:** 7-day free trial for new users
- **Billing Management:** User dashboard for subscription management
