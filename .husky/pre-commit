#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR | tr '\n' ' ')

# Protect curbos area from modifications
# Allow bypass with ALLOW_CURBOS_MODIFY=1 for emergency cases
if [ -z "$ALLOW_CURBOS_MODIFY" ]; then
  CURBOS_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '^app/curbos/' || true)

  if [ -n "$CURBOS_FILES" ]; then
    echo "❌ ERROR: Attempted to modify protected curbos area!"
    echo ""
    echo "The following files in app/curbos/ are protected:"
    echo "$CURBOS_FILES" | sed 's/^/  - /'
    echo ""
    echo "These files are tracked in git but should not be modified."
    echo "If you need to modify them (emergency only), use:"
    echo "  ALLOW_CURBOS_MODIFY=1 git commit ..."
    echo ""
    exit 1
  fi
fi

# Filter out curbos files from staged files for checks
FILTERED_STAGED_FILES=$(echo "$STAGED_FILES" | tr ' ' '\n' | grep -v '^app/curbos/' | tr '\n' ' ')

# Run unified cleanup check on staged files (if any, excluding curbos)
if [ -n "$FILTERED_STAGED_FILES" ]; then
  echo "Running cleanup checks on staged files (curbos area excluded)..."
  # Only fail on critical violations, warnings are allowed in pre-commit
  npm run cleanup:staged
  CLEANUP_EXIT=$?
  # Exit code 1 = critical violations, exit code 2 = warnings only
  if [ $CLEANUP_EXIT -eq 1 ]; then
    echo "❌ Critical violations found - commit blocked"
    exit 1
  fi
  # Exit code 2 (warnings) or 0 (pass) are allowed
fi

# Run lint-staged for formatting (excludes curbos via .prettierignore)
npm run format:staged
