name: Error Learning

on:
  workflow_run:
    workflows: ['ðŸš€ CI/CD Pipeline']
    types:
      - completed
  schedule:
    - cron: '0 3 * * 0' # Weekly Sunday 3 AM UTC
  workflow_dispatch:

jobs:
  capture-build-errors:
    name: Capture Build Errors
    runs-on: ubuntu-latest
    if: failure() # Only run if CI workflow failed
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      - run: npm ci
      - name: Capture build errors
        run: |
          # Capture TypeScript errors
          npm run type-check 2>&1 | tee /tmp/ts-errors.txt || true
          if [ -s /tmp/ts-errors.txt ]; then
            node scripts/error-capture/capture-error.js build /tmp/ts-errors.txt || true
          fi

          # Capture ESLint errors
          npm run lint 2>&1 | tee /tmp/lint-errors.txt || true
          if [ -s /tmp/lint-errors.txt ]; then
            node scripts/error-capture/capture-error.js build /tmp/lint-errors.txt || true
          fi

          # Capture build errors
          npm run build 2>&1 | tee /tmp/build-errors.txt || true
          if [ -s /tmp/build-errors.txt ]; then
            node scripts/error-capture/capture-error.js build /tmp/build-errors.txt || true
          fi
        continue-on-error: true

  detect-fixes:
    name: Detect Fixes
    runs-on: ubuntu-latest
    if: success() # Only run if CI workflow succeeded (errors were fixed)
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.sha }}
          fetch-depth: 10
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      - run: npm ci
      - name: Detect fixes from git history
        run: |
          node scripts/error-learning/detect-fixes.js detect || true
        continue-on-error: true
      - name: Auto-document fixes
        run: |
          node scripts/error-learning/auto-document-fix.js check || true
        continue-on-error: true
      - name: Generate rules and skill proposals
        run: |
          npm run skill:evolve -- --auto-map || true
        continue-on-error: true
      - name: Apply troubleshooting entries
        run: |
          npm run troubleshooting:apply || true
        continue-on-error: true
      - name: Commit and push learned docs
        if: github.event.workflow_run && github.event.workflow_run.head_branch == 'main'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/TROUBLESHOOTING_LOG.md docs/skill-learning/skill-mapping.json docs/SKILL_LEARNING.md 2>/dev/null || true
          if git diff --staged --quiet; then
            echo "No learned doc changes to commit."
          else
            git commit -m "docs: sync from error-learning (troubleshooting, skill-mapping, SKILL_LEARNING)"
            git push origin HEAD:main
          fi

  learning-report:
    name: Generate Learning Report
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      - run: npm ci
      - name: Generate weekly learning report
        run: |
          node scripts/error-learning/generate-learning-report.js 7
        continue-on-error: true
      - name: Upload learning report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: learning-report
          path: docs/errors/reports/
          retention-days: 30
          if-no-files-found: ignore
