name: Error Learning

on:
  workflow_run:
    workflows: ['CI']
    types:
      - completed
  workflow_dispatch:

jobs:
  capture-build-errors:
    name: Capture Build Errors
    runs-on: ubuntu-latest
    if: failure() # Only run if CI workflow failed
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      - run: npm ci
      - name: Capture build errors
        if: failure()
        run: |
          # Capture TypeScript errors
          npm run type-check 2>&1 | tee /tmp/ts-errors.txt || true
          if [ -s /tmp/ts-errors.txt ]; then
            node scripts/error-capture/capture-error.js build /tmp/ts-errors.txt || true
          fi
          
          # Capture ESLint errors
          npm run lint 2>&1 | tee /tmp/lint-errors.txt || true
          if [ -s /tmp/lint-errors.txt ]; then
            node scripts/error-capture/capture-error.js build /tmp/lint-errors.txt || true
          fi
          
          # Capture build errors
          npm run build 2>&1 | tee /tmp/build-errors.txt || true
          if [ -s /tmp/build-errors.txt ]; then
            node scripts/error-capture/capture-error.js build /tmp/build-errors.txt || true
          fi
        continue-on-error: true

  detect-fixes:
    name: Detect Fixes
    runs-on: ubuntu-latest
    if: success() # Only run if CI workflow succeeded (errors were fixed)
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 10 # Need git history for fix detection
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      - run: npm ci
      - name: Detect fixes from git history
        run: |
          node scripts/error-learning/detect-fixes.js detect || true
        continue-on-error: true
      - name: Auto-document fixes
        run: |
          node scripts/error-learning/auto-document-fix.js check || true
        continue-on-error: true
      - name: Generate rules
        run: |
          # Generate rules from knowledge base (if patterns detected)
          node -e "
            const { generateRulesFromKnowledgeBase } = require('./lib/error-learning/rule-generator.ts');
            generateRulesFromKnowledgeBase().catch(err => {
              console.error('Rule generation failed:', err);
              process.exit(0); // Don't fail the workflow
            });
          " || true
        continue-on-error: true

  learning-report:
    name: Generate Learning Report
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.event.schedule
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      - run: npm ci
      - name: Generate weekly learning report
        run: |
          node scripts/error-learning/generate-learning-report.js 7
        continue-on-error: true
      - name: Upload learning report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: learning-report
          path: docs/errors/reports/
          retention-days: 30
          if-no-files-found: ignore
